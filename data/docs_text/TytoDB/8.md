# Vacuum

Vacuum is a function that, when called by the database, runs in a container and cleans the tombstones in its file. This execution starts by scanning the entire dataset and pushing a boolean value that indicates whether the row is or is not a tombstone into a bitmap. Afterwards, two variables are declared: the first one is "cursor" and the other "back-cursor"; the cursor starts with a value of zero, and the back-cursor starts at N-1, where N is the bitmap length (count of elements). A loop runs until cursor > back-cursor, increasing the cursor value by one until it finds a tombstone in the bitmap at the index the cursor holds. Then, the loop state changes, and it starts decreasing the value of back-cursor until it finds a non-tombstone. After finding both a tombstone and a non-tombstone, both values are pushed into a vector that stores tuples of numbers (cursor and back-cursor positions).

After the loop involving direct interaction with the variables cursor and back-cursor ends, a for loop starts iterating through the vector of tuples, making swaps in the disk and the bitmap. After each swap, the references in the index map are updated, followed by an fsync. Although this slows the process down, it ensures data safety since a crash or power outage during this operation could be catastrophic, especially while there is no backup system like the one commit has with the MVCC.

```
+----------------------------------------------------------+
|                         VACUUM                           |
+----------------------------------------------------------+
| Step 1: Scan Container                                   |
|   -> Build bitmap: [0 = alive] [1 = tombstone]           |
|   Example: [0][1][0][1][0][0][1]                         |
+----------------------------------------------------------+
| Step 2: Initialize Cursors                               |
|   cursor = 0    back-cursor = N-1                        |
|   Loop until cursor > back-cursor                        |
|                                                          |
|   - Move cursor forward → find tombstone (1)             |
|   - Move back-cursor backward → find live row (0)        |
|   - Record tuple (cursor, back-cursor)                   |
+----------------------------------------------------------+
| Step 3: Swap Phase                                       |
|   For each tuple (tombstone_idx, live_idx):              |
|     - Swap rows on disk                                  |
|     - Swap entries in bitmap                             |
|     - Update index map pointers                          |
|     - fsync to disk (safety against crash/power loss)    |
+----------------------------------------------------------+
| Result:                                                  |
|   - Tombstones pushed to the back                        |
|   - Live rows compacted to the front                     |
|   - Container cleaned, index updated                     |
+----------------------------------------------------------+
```